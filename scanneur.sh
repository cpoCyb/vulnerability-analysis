#!/bin/bash

clear
echo "Quel score minimum ? (/100)"
read scoreMin

echo "Vérification de la validité des URLS"

# L'URL à vérifier
FICHIER_URLS="./liste.txt"
echo "Liste des urls non joignable" > ./ErreurCurl.txt
echo " " >> ./ErreurCurl.txt

while IFS= read -r url
do
# Utilise curl pour faire une requête HTTP et obtenir le code de réponse HTTP
http_status=$(curl -A "Mozilla/5.0 (X11; Linux x86_64; rv:109.0) Gecko/20100101 Firefox/115.0" -o /dev/null --silent --head --write-out '%{http_code}\n' "$url")

# Vérifie si le code de réponse est 200 (OK), 301 (Moved Permanently), ou 302 (Found)
if [ "$http_status" = "200" ] || [ "$http_status" = "301" ] || [ "$http_status" = "302" ]; then
  echo $url >> ResultCurl.txt
else
  echo "ATTENTION : $url n'est pas joignable !" >> ErreurCurl.txt
fi
done < "$FICHIER_URLS"

# OBSERVATORY

echo "Récupération des domaines à scanner"

# Chemin vers le fichier contenant les URLs
FICHIER_URLS="./ResultCurl.txt"
echo "Liste des urls aillant un score inférieur à $scoreMin" > ./result.txt
echo " " >> ./result.txt


# Lire le fichier /ResultCurl.txt ligne par ligne
while IFS= read -r url
do
    # Récupération uniquement du nom de domaine 
    echo $url | grep -oP '(?<=://)[^/]+' | sed 's/^www\.//' >> ./ListTest.txt
done < "$FICHIER_URLS"

echo "Scan des urls pour remonté les vulnérabilités"

FICHIER_DOMAINES="./ListTest.txt"
while IFS= read -r domaine
do
    observatory $domaine --format=report > ./report/$domaine.txt # Traitement par observatory puis stockage dans /report/$domaine.txt
    grep 'Score: ' ./report/$domaine.txt > ./score/$domaine.txt # Recherche de la varible score dans /report/$domaine.txt puis stockage dans /score/$domaine.txt
    nombre=$(grep -o '[0-9]\+' ./score/$domaine.txt | head -n 1) # Recupération du score et stockage dans la variable nombre
    # Vérification si le score et inférieur à $scoreMin
    if [ $nombre -le $scoreMin ]; then
        if [ $nombre -le 10 ]; then
        echo "\033[31mDANGER\033[0m", le score de $domaine et de $nombre >> ./result.txt
        else
        echo "ATTENTION, le score de $domaine et de $nombre" >> ./result.txt
        fi
    fi
done < "$FICHIER_DOMAINES"

cat result.txt
cat ErreurCurl.txt

echo "Récupération possible des fichiers : result.txt / ErreurCurl.txt"

rm -R ./report
rm  -R ./score
mkdir ./report/
mkdir  ./score/
rm ./ListTest.txt
rm ./ResultCurl.txt